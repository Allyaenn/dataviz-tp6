<!DOCTYPE html>
<meta charset="utf-8">
<style>

  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
  }

  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }

</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.id; }))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));

    function searchActors(votes, actors){

        var index = -1;
        for (var i =  0; i<votes.length; i++){
            if (votes[i].actors == actors){
                index = i;
            }
        }
        return index;
    }

    d3.json("scrutins.json", function(error, graph) {
        if (error) throw error;

        //calcul des votes communs en parcourant les scrutins
        // recupérer paire de votants + valeur
        //construire une table contenant les personnes
        console.log(graph);

        var scrutin2015 = [];
        var year;
        var votesCommuns = {};
        var index;

        for (var i = 0; i<graph.scrutins.scrutin.length;i++) {

            year = graph.scrutins.scrutin[i].dateScrutin.slice(0,4);
            //console.log(year);
            if (year == "2015")
            {
                scrutin2015.push(graph.scrutins.scrutin[i]);
            }

        }

        var vPours = [];
        var vContres = [];
        //console.log("test2 : " +  graph.scrutins.scrutin.length);
        for (var i = 0; i<scrutin2015.length;i++){ // parcours des scrutins
            //console.log(i);
            vPours.length = 0;
            vContres.length =0;
            var votesParGrp;
            var compteurPour = 0;
            var compteurContre = 0;

            for (var j = 0; j<scrutin2015[i].ventilationVotes.organe.groupes.groupe.length;j++) //parcours des groupes
            {
                votesParGrp = scrutin2015[i].ventilationVotes.organe.groupes.groupe[j].vote.decompteNominatif;

                if (votesParGrp.contres !== null)
                {
                    if (!(votesParGrp.contres.votant instanceof Array)) {
                        vPours.push(votesParGrp.contres.votant.acteurRef);
                        compteurContre++;
                    }
                    for (var k = 0; k < votesParGrp.contres.votant.length; k++) {
                        vContres.push(votesParGrp.contres.votant[k].acteurRef);
                        compteurContre++;
                    }
                }

                if (votesParGrp.pours !== null)
                {
                    if (!(votesParGrp.pours.votant instanceof Array)) {
                        vPours.push(votesParGrp.pours.votant.acteurRef);
                        compteurPour++;
                    }
                    for (var l = 0; l < votesParGrp.pours.votant.length; l++) {
                        vPours.push(votesParGrp.pours.votant[l].acteurRef);
                        compteurPour++;
                    }
                }
            }

            if (i == 1) {
                console.log("****************************************************** Scrutin n°" + i);
                console.log("POUR : " + compteurPour);
                console.log("taille tab pour " + vPours.length);
                console.log("CONTRE : " + compteurContre);
                console.log("taille tab contre " + vContres.length);
            }

            //parcours des tableaux vPours et vContres pour créer les paires de votants
            for (var m = 0; m < vPours.length; m++) {
                for (var n = m + 1; n < vPours.length; n++) {
                    if (vPours[m] < vPours[n]) {
                        var ch = vPours[m] + "_" + vPours[n];
                    } else {
                        var ch = vPours[n] + "_" + vPours[m];
                    }

                    if (!(ch in votesCommuns)) {
                        votesCommuns[ch] = 1;
                    }
                    else {
                        votesCommuns[ch]++;
                    }
                }
            }

            for (var m = 0; m < vContres.length; m++) {
                for (var n = m + 1; n < vContres.length; n++) {
                    if (vContres[m] < vContres[n]) {
                        var ch = vContres[m] + "_" + vContres[n];
                    }
                    else {
                        var ch = vContres[n] + "_" + vContres[m];
                    }

                    if (!(ch in votesCommuns)) {
                        votesCommuns[ch] = 1;
                    }
                    else {
                        votesCommuns[ch]++;
                    }
                }
            }

        }
        //console.log(votesCommuns);

        var vcSup20 = {};

        for(var key in votesCommuns){
            if (votesCommuns[key] >= 20){
                vcSup20[key] = votesCommuns[key];
            }
        }

        console.log(vcSup20);

      var link = svg.append("g")
       .attr("class", "links")
       .selectAll("line")
       .data(graph.links)
       .enter().append("line")
       .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

       var node = svg.append("g")
       .attr("class", "nodes")
       .selectAll("circle")
       .data(graph.acteurs)
       .enter().append("circle")
       .attr("r", 5)
       .attr("fill", function(d) { return d; })
       .call(d3.drag()
       .on("start", dragstarted)
       .on("drag", dragged)
       .on("end", dragended));

       node.append("title")
       .text(function(d) { return d.id; });

       simulation
       .nodes(graph.nodes)
       .on("tick", ticked);

       simulation.force("link")
       .links(graph.links);

       function ticked() {
       link
       .attr("x1", function(d) { return d.source.x; })
       .attr("y1", function(d) { return d.source.y; })
       .attr("x2", function(d) { return d.target.x; })
       .attr("y2", function(d) { return d.target.y; });

       node
       .attr("cx", function(d) { return d.x; })
       .attr("cy", function(d) { return d.y; });
       }
    });

    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

</script>

TP6 Dataviz :)